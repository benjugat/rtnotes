---
title: Modules Enumeration
category: Maldev-Object Enumeration
order: 2
---

Modules are the libraries (dlls) that are already loaded on a process.

If Our payload needs to connect via internet, it's a good technique to inject into a process that already has the appropiate dlls loaded. So we need to find which modules are loaded on the procceses. An example of a target dll is `WS2_32.dll`

# CreateToolhelp32Snapshot (Classic technique) (WinAPI)

* [https://learn.microsoft.com/en-us/windows/win32/api/tlhelp32/nf-tlhelp32-createtoolhelp32snapshot](https://learn.microsoft.com/en-us/windows/win32/api/tlhelp32/nf-tlhelp32-createtoolhelp32snapshot)

*Takes a snapshot of the specified processes, as well as the heaps, modules, and threads used by these processes.*

*If the function succeeds, it returns an open handle to the specified snapshot.*

```cpp
HANDLE CreateToolhelp32Snapshot(
  [in] DWORD dwFlags,
  [in] DWORD th32ProcessID
);
```
*dwFlags=`TH32CS_SNAPMODULE` -> Includes all modules of the process specified in th32ProcessID in the snapshot. To enumerate the modules, see `Module32First` and `Module32Next`. If the function fails with `ERROR_BAD_LENGTH`, retry the function until it succeeds.*

Final code:

```cpp
#include <Windows.h>
#include <stdio.h>
#include <tlhelp32.h>

int ListModules(int pid){
    HANDLE hSnapshot;
    MODULEENTRY32 lpme;
    hSnapshot = CreateToolhelp32Snapshot(TH32CS_SNAPMODULE, pid);

    if(INVALID_HANDLE_VALUE == hSnapshot){
        return -1;
    }

    lpme.dwSize = sizeof(MODULEENTRY32);

    // Snapshot done!
    if(!Module32First(hSnapshot, &lpme)){
        CloseHandle(hSnapshot);
        return -1;
    }
    printf("%#25s\t\t\t%#10s\t\t%#10s\n", "Module", "Base Address", "Size");
    printf("------------------------------------------------------------------------------------------------\n");
    do{
        printf("%#25s\t\t0x%#10p\t\t%#10d\n", lpme.szModule,lpme.modBaseAddr, lpme.modBaseSize);
    } while(Module32Next(hSnapshot, &lpme));

    CloseHandle(hSnapshot);
    return 1;

}

int main(int argc, char ** argv) {
    
    int pid = 3584;
    ListModules(pid);
    return 0;
}
```

Here we can see the output of targeting `notepad.exe`.

![](/rtnotes/images/list-modules.png)