---
title: Handle Enumeration
category: Maldev-Object Enumeration
order: 3
---

It is common to some defenses to detect patterns, one typicall is create a handle of a remote process. The idea is to enumerate them and find a process who has full access `0x1fffff` to a process, use that handle to inject our code.

# NtQuerySystemInformation (NativeAPI)

The `NtQuerySystemInformation` function can return a list of all open handles in the system, including those associated with a specific process. This technique uses the `SystemHandleInformation` (code 16) to obtain information about handles.


* [https://learn.microsoft.com/en-us/windows/win32/api/winternl/nf-winternl-ntquerysysteminformation](https://learn.microsoft.com/en-us/windows/win32/api/winternl/nf-winternl-ntquerysysteminformation)

```cpp
__kernel_entry NTSTATUS NtQuerySystemInformation(
  [in]            SYSTEM_INFORMATION_CLASS SystemInformationClass,
  [in, out]       PVOID                    SystemInformation,
  [in]            ULONG                    SystemInformationLength,
  [out, optional] PULONG                   ReturnLength
);
```

Since `SYSTEM_HANDLE_INFORMATION` is not defined we should define the structs.

```cpp
typedef struct _SYSTEM_HANDLE {
    ULONG ProcessId;
    BYTE ObjectTypeNumber;
    BYTE Flags;
    USHORT Handle;
    PVOID Object;
    ACCESS_MASK GrantedAccess;
} SYSTEM_HANDLE, *PSYSTEM_HANDLE;

typedef struct _SYSTEM_HANDLE_INFORMATION {
    ULONG HandleCount;
    SYSTEM_HANDLE Handles[1];
} SYSTEM_HANDLE_INFORMATION, *PSYSTEM_HANDLE_INFORMATION;
```


There are different types of Handles (directory, token, file, events, keys...) each one has a different `ObjectTypeNumer`.


| **ObjectTypeNumber** | **ObjectType** | **Description**                      |
|:--------------------:|:--------------:|--------------------------------------|
|         0x02         |     Process    | _Open process_                       |
|         0x03         |     Thread     | _Tread of a process_                 |
|         0x04         |      Token     | _Security token_                     |
|         0x05         |      Event     | _Event object (manual or automatic)_ |
|         0x09         |      File      | _Open file_                          |
|         0x0B         |       Key      | _Windows registry key_               |
|         0x0D         |     FileMap    | _File mapping (shared memory)_       |
|         0x15         |    Directory   | _Directory object_                   |
|         0x16         |      Token     | _Duplicated security token_          |

Example of a code that list all the handles of a process.

```cpp
#include <Windows.h>
#include <stdio.h>
#include <winternl.h>

#define SystemHandleInformation 16

#define STATUS_INFO_LENGTH_MISMATCH ((NTSTATUS)0xC0000004L)


typedef struct _SYSTEM_HANDLE {
    ULONG ProcessId;
    BYTE ObjectTypeNumber;
    BYTE Flags;
    USHORT Handle;
    PVOID Object;
    ACCESS_MASK GrantedAccess;
} SYSTEM_HANDLE, *PSYSTEM_HANDLE;

typedef struct _SYSTEM_HANDLE_INFORMATION {
    ULONG HandleCount;
    SYSTEM_HANDLE Handles[1024];
} SYSTEM_HANDLE_INFORMATION, *PSYSTEM_HANDLE_INFORMATION;


typedef NTSTATUS (WINAPI * t_NtQuerySystemInformation)(
    SYSTEM_INFORMATION_CLASS SystemInformationClass,
    PVOID SystemInformation,
    ULONG SystemInformationLength,
    PULONG ReturnLength
);


int ListHandles(int pid) {
    PVOID buffer = NULL;

    DWORD sysHandleSize = 0x10000;
    SYSTEM_HANDLE_INFORMATION * sysHandle;
    NTSTATUS status;

    // Link NtQuerySystemInformation 
    t_NtQuerySystemInformation pNtQuerySystemInformation;
    pNtQuerySystemInformation = (t_NtQuerySystemInformation)GetProcAddress(GetModuleHandle("ntdll.dll"),"NtQuerySystemInformation");

    // Get INITIAL size
    sysHandle = (SYSTEM_HANDLE_INFORMATION*)malloc(sysHandleSize);
    while((status = pNtQuerySystemInformation((SYSTEM_INFORMATION_CLASS) SystemHandleInformation, sysHandle, sysHandleSize, NULL))==STATUS_INFO_LENGTH_MISMATCH){
        sysHandle = (SYSTEM_HANDLE_INFORMATION *)realloc(sysHandle,sysHandleSize*=2);
    }

    printf("PID\tObjectTypeNumber\tGrantedAccess\n");
    printf("---------------------------------------------------\n");
    for (int i=0; i<sysHandle->HandleCount; i++){
        SYSTEM_HANDLE handle = sysHandle->Handles[i];
        if(handle.ProcessId == pid){
            printf("%#5d\t%#16x\t%#13x\n", handle.ProcessId, handle.ObjectTypeNumber,handle.GrantedAccess);
        }
    }	
	return 0;
}

int main(int argc, char ** argv) {
    
    int pid = 2260;
    ListHandles(pid);
    return 0;
}
```